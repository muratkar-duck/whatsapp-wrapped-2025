<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WhatsApp 2025 Wrapped</title>
  <style>
    :root {
      --bg: #f6f3f9;
      --page: #ffffff;
      --text: #1f1633;
      --muted: #6c6880;
      --accent: #b14aed;
      --accent-soft: #efe7fb;
      --card: #fbf9fe;
      --line: #e5ddf5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter','Segoe UI',system-ui,-apple-system,sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    h1,h2,h3,h4 { margin: 0 0 8px; font-weight: 800; letter-spacing: -0.3px; }
    p { margin: 0 0 8px; }

    .controls {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(246,243,249,0.96);
      backdrop-filter: blur(10px);
      padding: 14px 18px;
      border-bottom: 1px solid var(--line);
      display: flex;
      flex-wrap: wrap;
      gap: 12px 18px;
      align-items: flex-end;
    }
    .controls label { font-weight: 700; font-size: 13px; color: var(--muted); display:block; margin-bottom: 6px; }
    .controls input[type=file] { padding: 8px 10px; border: 1px solid var(--line); border-radius: 10px; background: #fff; min-width: 220px; }
    .controls button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 800;
      cursor: pointer;
      color: #fff;
      background: var(--accent);
      box-shadow: 0 10px 26px rgba(177,74,237,0.25);
    }
    .controls .ghost { background: #2f2646; box-shadow: none; color: #fff; }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; background: var(--accent-soft); border-radius: 999px; color: var(--accent); font-weight: 700; font-size: 13px; }

    .screen-nav {
      position: sticky;
      top: 78px;
      z-index: 15;
      display: flex;
      gap: 6px;
      padding: 10px 16px;
      overflow-x: auto;
      background: rgba(246,243,249,0.96);
      border-bottom: 1px solid var(--line);
    }
    .screen-nav a { text-decoration: none; color: var(--muted); padding: 8px 10px; border-radius: 10px; background: #fff; border: 1px solid var(--line); font-weight: 700; font-size: 13px; white-space: nowrap; }
    .screen-nav a:hover { background: var(--accent-soft); color: var(--accent); }

    .pages { max-width: 940px; margin: 0 auto 48px; padding: 12px; }
    .page {
      background: var(--page);
      width: 210mm;
      min-height: 297mm;
      margin: 18px auto;
      padding: 20mm 18mm;
      box-shadow: 0 18px 38px rgba(20,12,40,0.08);
      border-radius: 18px;
      page-break-after: always;
      break-after: page;
    }
    .page:last-child { page-break-after: auto; }
    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
    .page-title { font-size: 28px; }
    .page-sub { color: var(--muted); font-weight: 600; margin-top: 2px; }

    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.9); }
    .card h3 { font-size: 16px; margin-bottom: 6px; }
    .card h4 { font-size: 14px; margin-top: 8px; }
    .kpi { font-size: 28px; font-weight: 800; margin: 4px 0; }
    .muted { color: var(--muted); font-size: 12px; }
    .tag { background: var(--accent-soft); color: var(--accent); padding: 3px 8px; border-radius: 10px; font-weight: 700; font-size: 12px; }
    .list { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
    .list li { padding: 10px 12px; border-radius: 12px; background: #f8f6fb; border: 1px solid var(--line); font-size: 13px; }

    .two-col { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .badge { display: inline-flex; align-items: center; gap: 6px; background: #111; color: #fff; padding: 6px 10px; border-radius: 999px; font-size: 12px; }
    .note { font-size: 11px; color: var(--muted); }
    .chart-box { background: #fff; border-radius: 14px; border: 1px solid var(--line); padding: 10px; }
    canvas { width: 100%; height: 240px; display: block; }

    svg.chart { width: 100%; height: 260px; display: block; font-family: 'Inter','Segoe UI',system-ui,-apple-system,sans-serif; }
    .chart text { fill: #2b213f; font-size: 12px; }
    .chart .axis { stroke: #2b213f; stroke-width: 1; }
    .chart .grid { stroke: #e4deef; stroke-width: 1; }
    .chart .label { font-weight: 700; }
    .chart .title { font-size: 14px; font-weight: 800; }
    .chart .subtitle { font-size: 12px; fill: var(--muted); }

    .word-cloud-frame { background: #f8f5fd; border-radius: 16px; padding: 14px; aspect-ratio: 3 / 2; width: 100%; max-width: 900px; margin: 0 auto; box-shadow: inset 0 0 0 1px var(--line), 0 10px 26px rgba(51,27,92,0.08); border: 1px solid var(--line); }
    .word-cloud-frame canvas { width: 100%; height: 100% !important; display: block; background: transparent; }
    .word-cloud-hint { color: #6b5d8a; font-size: 12px; text-align: center; margin-top: 8px; }
    .word-cloud-settings { margin-top: 8px; border-top: 1px solid var(--line); padding-top: 8px; }
    .word-cloud-settings label { display: block; margin-bottom: 6px; color: #2b213f; font-weight: 700; }
    .word-cloud-settings input, .word-cloud-settings select { width: 100%; margin-bottom: 6px; }
    .emoji-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; text-align: center; }
    .emoji-item { font-size: 36px; line-height: 1.2; }
    .two-col-list { columns: 2; column-gap: 12px; }
    .two-col-list li { break-inside: avoid; }

    .closing-input { width: 100%; min-height: 160px; padding: 12px; border-radius: 12px; border: 1px solid var(--line); font-size: 14px; }

    .print-canvas-image { display: block; width: 100%; height: auto; }
    .hidden { display: none !important; }
    .no-print { }
    .extra { display: none; }
    body.show-full .extra { display: block; }
    .print-mode * { animation: none !important; transition: none !important; }
    .debug {
      position: fixed; right: 12px; bottom: 12px;
      width: 320px; max-height: 70vh; overflow: auto;
      background: rgba(18,16,34,0.9); color: #e5defc;
      padding: 12px; border-radius: 12px; font-size: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.35);
    }

    @page { size: A4; margin: 0; }

    @media print {
      body { background: #fff; }
      .controls, .screen-nav, .debug, .no-print { display: none !important; }
      .page { box-shadow: none; margin: 0 auto; width: auto !important; min-height: auto !important; padding: 14mm 12mm 12mm !important; border-radius: 0 !important; }
      .grid{ display:grid !important; grid-template-columns: repeat(12, minmax(0,1fr)) !important; gap: 12px !important; }
      .card { margin-bottom: 0; break-inside: avoid; page-break-inside: avoid; }
      .chart-box { margin: 8mm 0; break-inside: avoid; }
      .page, .page * { transition: none !important; animation: none !important; }
      .page { break-after: page; box-shadow:none !important; }
      .avoid-break { break-inside: avoid; }
      .print-trim { display: none !important; }
      .extra { display: none !important; }
      canvas { height: 200px; }
      svg.chart text { font-size: 11px; }
    }
  </style>
</head>
<body>
  <div class="controls no-print">
    <div>
      <label>Sohbet .txt</label>
      <input type="file" id="fileInput" accept="text/plain">
    </div>
    <div>
      <label>Medya klasÃ¶rÃ¼ (opsiyonel)</label>
      <input type="file" id="mediaInput" webkitdirectory directory multiple>
    </div>
    <div class="flex" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <button id="analyzeBtn">Analiz Et</button>
      <button id="preparePrintBtn">PDFâ€™e HazÄ±rla</button>
      <button id="toggleFullBtn" class="ghost">TÃ¼m listeleri gÃ¶ster</button>
      <span class="pill">Ä°pucu: DosyayÄ± seÃ§, analiz et, PDFâ€™e hazÄ±rlayÄ±p yazdÄ±r (arka plan grafiklerini aÃ§).</span>
    </div>
  </div>
  <div class="screen-nav no-print" id="nav"></div>
  <div id="content" class="pages"></div>
  <div id="debug" class="debug hidden"></div>

  <script>
    const TURKISH_STOP = new Set(['ve','veya','ile','ama','fakat','lakin','de','da','ki','bu','su','ÅŸu','o','bir','bi','ne','mi','mÄ±','mu','mÃ¼','iÃ§in','gibi','Ã§Ã¼nkÃ¼','ya','sen','ben','biz','siz','onlar','ÅŸimdi','daha','Ã§ok','az','her','en','ile','ya','yao','diye','di','deÄŸil','vardÄ±','bÃ¶yle','hala','hem','hep','hepimiz','yani','ise','yada','veya','veya','ÅŸey','aslÄ±nda','muhtemelen','mÄ±','mi','mu','mÃ¼','ÅŸu','falan','filan','bugÃ¼n','yarÄ±n','akÅŸam','sabah','Ã¶ÄŸlen','sonra','Ã¶nce']);
    const ROMANTIC = ['aÅŸkÄ±m','canÄ±m','bebeÄŸim','tatlÄ±m','seviyorum','seni seviyorum','Ã¶zledim','sevgilim','kalbim','hayatÄ±m','prenses','prensim','balÄ±m','gÃ¼zelim','yavrum','Ã§ekim'];
    const DATEI_TOKENS = ['datei','date\'i','date i','dateâ€™i','date i'];
    const TOPIC_CATS = {
      'Ä°ÅŸ & okul': ['iÅŸ','ofis','mesai','sÄ±nav','okul','ders','Ã¶dev','proje','toplantÄ±'],
      'Yemek & kahve': ['kahve','yemek','restoran','kahvaltÄ±','akÅŸam yemeÄŸi','Ã§ay','pizza','burger','tatlÄ±'],
      'UlaÅŸÄ±m & yol': ['metro','otobÃ¼s','uÃ§ak','uÃ§uÅŸ','havaalanÄ±','trafik','yol','taksi','uber'],
      'Seyahat & tatil': ['otel','tatil','rezervasyon','uÃ§uÅŸ','bilet','uÃ§ak','gezi','gezmek','tatilde'],
      'Aile & arkadaÅŸ': ['annem','babam','kardeÅŸim','arkadaÅŸ','dost','kuzen','ailem','dÃ¼ÄŸÃ¼n'],
      'SaÄŸlÄ±k & spor': ['spor','koÅŸu','yÃ¼rÃ¼yÃ¼ÅŸ','fitness','saÄŸlÄ±k','ilaÃ§','hastane','aÄŸrÄ±','yoga'],
      'EÄŸlence & film': ['film','dizi','netflix','sinema','oyun','oynadÄ±m','fragman','konser'],
      'Teknoloji': ['telefon','bilgisayar','uygulama','kod','api','internet','ÅŸarj','kulaklÄ±k'],
      'Para & alÄ±ÅŸveriÅŸ': ['alÄ±ÅŸveriÅŸ','fiyat','indirim','para','maaÅŸ','Ã¶deme','kart','market','fatura'],
      'Hava & gÃ¼n': ['hava','yaÄŸmur','gÃ¼neÅŸ','soÄŸuk','sÄ±cak','mevsim','bahar','kÄ±ÅŸ','yaz'],
      'Duygu & motivasyon': ['mutlu','Ã¼zgÃ¼n','mutsuz','sinir','heyecan','motive','enerji','yorgun'],
      'Plan & etkinlik': ['plan','buluÅŸma','event','etkinlik','parti','doÄŸum gÃ¼nÃ¼','kutlama']
    };

    const laughRegex = /(?:ðŸ˜‚|ðŸ¤£|haha|ahah|kdkd|sjsj|xdd|:p)/i;
    const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+)/gi;

    function looksLikeLaugh(text){
      if(!text) return false;
      const normalized = normalizeText(text);
      const smash = /[ahsjdkgp]{4,}/i;
      const burst = /(haha|ahah|sjsj|kdkd|lol|lmao|x?dd)/i;
      return laughRegex.test(text) || burst.test(normalized) || smash.test(normalized);
    }

    function scoreLaughBurst(text){
      const emojis = (text.match(/ðŸ˜‚|ðŸ¤£/g)||[]).length;
      const lenBonus = Math.min(Math.max(text.length-4,0)/10, 3);
      return 1 + emojis + lenBonus;
    }

    function getStorage(){
      try { if (typeof localStorage !== 'undefined') return localStorage; } catch(e){}
      const mem = {};
      return {
        getItem:k=> (k in mem ? mem[k] : null),
        setItem:(k,v)=> { mem[k]=String(v); },
        removeItem:k=> { delete mem[k]; }
      };
    }

    const STORAGE = getStorage();
    const contentEl = document.getElementById('content');
    const debugEl = document.getElementById('debug');
    const preparePrintBtn = document.getElementById('preparePrintBtn');
    const navEl = document.getElementById('nav');
    let showFull = false;

    let latestAgg = null;
    let latestParsed = null;
    let latestPages = [];
    const wordCloudConfig = {
      maxWordsScreen: 140,
      maxWordsPrint: 120,
      minFont: 16,
      maxFont: 86,
      minFrequency: 2,
      rotationRatio: 0.28,
      allowRotate: true
    };
    const WORD_CLOUD_PALETTE = ['#34d399','#22d3ee','#f59e0b','#f472b6','#eab308','#60a5fa','#a855f7','#2dd4bf','#fb7185','#38bdf8','#f97316','#f43f5e','#10b981','#c084fc','#8b5cf6','#facc15'];

    function createAnalysisWorker(){
      const code = `
        const TURKISH_STOP = new Set(${JSON.stringify([...TURKISH_STOP])});
        const ROMANTIC = ${JSON.stringify(ROMANTIC)};
        const DATEI_TOKENS = ${JSON.stringify(DATEI_TOKENS)};
        const TOPIC_CATS = ${JSON.stringify(TOPIC_CATS)};
        const WORD_CLOUD_PALETTE = ${JSON.stringify(WORD_CLOUD_PALETTE)};
        const urlRegex = ${urlRegex.toString()};
        const laughRegex = ${laughRegex.toString()};
        ${stripUrls.toString()};
        ${dayKey.toString()};
        ${monthKey.toString()};
        ${hourOfDay.toString()};
        ${weekday.toString()};
        ${weekKey.toString()};
        ${bucketRange.toString()};
        ${tokenize.toString()};
        ${stripDiacritics.toString()};
        ${normalizeText.toString()};
        ${extractEmojiTokens.toString()};
        ${isEmojiCluster.toString()};
        ${looksLikeLaugh.toString()};
        ${scoreLaughBurst.toString()};
        ${classify.toString()};
        ${parseChat.toString()};
        ${parseDuration.toString()};
        ${bucketReply.toString()};
        ${computeStickers.toString()};
        ${fillWeek.toString()};
        ${buildOverlay.toString()};
        ${computeAnalytics.toString()};
        self.onmessage = (e)=>{
          const {text, stickerIndex} = e.data;
          const parsed = parseChat(text);
          const agg = computeAnalytics(parsed.messages, parsed.range, stickerIndex||[]);
          self.postMessage({parsed:{...parsed, messagesCount: parsed.messages.length}, agg});
        };
      `;
      const blob = new Blob([code], {type:'application/javascript'});
      const worker = new Worker(URL.createObjectURL(blob));
      return worker;
    }

    const analysisWorker = createAnalysisWorker();
    analysisWorker.onerror = (err)=>{
      debugEl.classList.remove('hidden');
      debugEl.textContent = 'Worker error: '+(err.message||err.filename||'bilinmiyor');
      console.error('Worker error', err);
      alert('Analiz iÅŸÃ§isinde hata: '+(err.message||err));
    };

    document.getElementById('analyzeBtn').addEventListener('click', handleAnalyze);
    preparePrintBtn.addEventListener('click', prepareForPDF);
    document.getElementById('toggleFullBtn').addEventListener('click', ()=>{
      showFull = !showFull;
      document.body.classList.toggle('show-full', showFull);
    });

    let mediaFiles = [];
    document.getElementById('mediaInput').addEventListener('change', (e)=>{
      mediaFiles = Array.from(e.target.files || []);
    });

    async function handleAnalyze(){
      try {
        const file = document.getElementById('fileInput').files[0];
        if(!file){ alert('LÃ¼tfen sohbet .txt dosyasÄ±nÄ± seÃ§in'); return; }
        const text = await file.text();
        const stickerIndex = await buildStickerIndex(mediaFiles);
        const wait = new Promise((resolve)=>{
          analysisWorker.onmessage = (e)=>resolve(e.data);
        });
        analysisWorker.postMessage({text, stickerIndex});
        const {parsed, agg} = await wait;
        const enrichedAgg = {...agg, stickerGroups: enrichStickerLabels(agg.stickerGroups)};
        latestAgg = enrichedAgg;
        latestParsed = parsed;
        renderAll(parsed, enrichedAgg);
        renderDebug(parsed, enrichedAgg);
      } catch(err){
        console.error('Analiz hatasÄ±', err);
        debugEl.classList.remove('hidden');
        debugEl.innerHTML = '<strong>Hata</strong><br>'+ (err?.stack||err?.message||err);
        alert('Analiz sÄ±rasÄ±nda hata oluÅŸtu: '+(err?.message||err));
      }
    }

    function freezeCanvasesForPrint(){
      document.querySelectorAll('canvas').forEach(canvas => {
        const rect = canvas.getBoundingClientRect();
        const width = Math.max(1, Math.round(rect.width || canvas.clientWidth || canvas.width));
        const height = Math.max(1, Math.round(rect.height || canvas.clientHeight || canvas.height));
        const exportCanvas = document.createElement('canvas');
        exportCanvas.width = width;
        exportCanvas.height = height;
        const ctx = exportCanvas.getContext('2d');
        try {
          ctx.drawImage(canvas, 0, 0, width, height);
        } catch (e) {
          exportCanvas.width = canvas.width;
          exportCanvas.height = canvas.height;
          ctx.drawImage(canvas, 0, 0);
        }
        const img = document.createElement('img');
        img.src = exportCanvas.toDataURL('image/png');
        img.style.width = width + 'px';
        img.style.height = height + 'px';
        img.className = 'print-canvas-image';
        canvas.replaceWith(img);
      });
    }

    function nextFrame(){
      return new Promise(r=>requestAnimationFrame(()=>r()));
    }

    function forceDrawAllCanvases(agg,{mode='screen'}={}){
      if(!agg) return;
      document.querySelectorAll('canvas[data-type]').forEach(cv=>{
        const type=cv.dataset.type;
        if(type==='line') drawLineChart(cv, agg.daily);
        else if(type==='month') drawBarChartMonth(cv, agg.monthly);
        else if(type==='hours') drawBarChartHours(cv, agg.hourly);
        else if(type==='week') drawBarChartWeekdays(cv, agg.weekDay);
        else if(type==='hist') drawHistogram(cv, agg.hist);
        else if(type==='dateweek') drawMapChart(cv, agg.dateWeek);
        else if(type==='overlay') drawOverlay(cv, agg.weeklyOverlay);
        else if(type==='wordcloud') drawWordCloud(cv, agg, mode);
      });
    }

    async function prepareForPDF(){
      if(!latestAgg || !latestPages?.length){
        alert('Ã–nce Analiz Et ile veriyi Ã¼retmelisin');
        return;
      }
      document.body.classList.add('print-mode');

      renderAllPagesSync(latestPages, latestAgg);
      await nextFrame(); await nextFrame();
      forceDrawAllCanvases(latestAgg, {mode:'print'});
      await nextFrame();
      freezeCanvasesForPrint();
      setTimeout(()=>window.print(), 50);
    }
    window.addEventListener('afterprint', ()=>{
      document.body.classList.remove('print-mode');
      if(latestParsed && latestAgg){
        renderAll(latestParsed, latestAgg);
      }
    });

    function parseChat(text){
      const lines = text.split(/\r?\n/);
      const msgPattern = /^\[(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{2}):(\d{2}):(\d{2})\] ([^:]+): (.*)$/;
      const messages=[]; let parseErrors=0; let current=null; let range={min:null,max:null};
      const pushCurrent=()=>{ if(!current) return; const kind = classify(current.rawText); current.kind=kind; if(kind==='system'||kind==='deleted'){ current=null; return;} current.cleanText = stripUrls(current.rawText); messages.push(current); if(!range.min||current.ts<range.min) range.min=current.ts; if(!range.max||current.ts>range.max) range.max=current.ts; current=null; };
      for(const line of lines){
        const m = line.match(msgPattern);
        if(m){
          pushCurrent();
          const [_,d,mo,y,hh,mm,ss,name,rest] = m;
          const ts = new Date(Number(y), Number(mo)-1, Number(d), Number(hh), Number(mm), Number(ss));
          current = {ts, sender:name.trim(), rawText:rest};
        } else {
          if(current){ current.rawText += "\n"+line; }
          else { parseErrors++; }
        }
      }
      pushCurrent();
      return {messages, parseErrors, lines:lines.length, range};
    }

    function classify(text){
      if(!text) return 'text';
      if(/Bu mesaj silindi/i.test(text)) return 'deleted';
      if(/gruba eklendi|gruptan Ã§Ä±karÄ±ldÄ±|uÃ§tan uca|ÅŸifrelenmiÅŸtir|grup bilgisi|mesajlar ve aramalar/i.test(text)) return 'system';
      if(/<[^>]*-PHOTO-[^>]*>/i.test(text)) return 'photo';
      if(/<[^>]*-VIDEO-[^>]*>/i.test(text)) return 'video';
      if(/<[^>]*-AUDIO-[^>]*>/i.test(text)) return 'audio';
      if(/<[^>]*-STICKER-[^>]*>/i.test(text)) return 'sticker';
      if(/GÃ¶rÃ¼ntÃ¼lÃ¼ arama\. .*CevaplanmadÄ±/i.test(text)) return 'call_video_missed';
      if(/Sesli arama\. .*CevaplanmadÄ±/i.test(text)) return 'call_voice_missed';
      if(/GÃ¶rÃ¼ntÃ¼lÃ¼ arama\./i.test(text) && /saat|dk|sn\./i.test(text)) return 'call_video_answered';
      if(/Sesli arama\./i.test(text) && /saat|dk|sn\./i.test(text)) return 'call_voice_answered';
      return 'text';
    }

    function stripUrls(t){
      return (t||'').replace(urlRegex,'').trim();
    }

    function dayKey(ts){ return `${ts.getFullYear()}-${String(ts.getMonth()+1).padStart(2,'0')}-${String(ts.getDate()).padStart(2,'0')}`; }
    function monthKey(ts){ return `${ts.getFullYear()}-${String(ts.getMonth()+1).padStart(2,'0')}`; }
    function hourOfDay(ts){ return ts.getHours(); }
    function weekday(ts){ return (ts.getDay()+6)%7; }

    function weekKey(ts){
      const d = new Date(ts.getFullYear(), ts.getMonth(), ts.getDate());
      const day = (d.getDay()+6)%7;
      d.setDate(d.getDate()-day+3);
      const firstThursday = new Date(d.getFullYear(),0,4);
      const diff = d - firstThursday;
      const week = 1 + Math.round(diff/ (7*24*3600*1000));
      return { key: `${d.getFullYear()}-W${String(week).padStart(2,'0')}`, week };
    }

    function bucketRange(range){
      const days=[];
      if(!range.min||!range.max) return days;
      const d = new Date(range.min.getFullYear(), range.min.getMonth(), range.min.getDate());
      const end = new Date(range.max.getFullYear(), range.max.getMonth(), range.max.getDate());
      while(d<=end){ days.push(new Date(d)); d.setDate(d.getDate()+1);} return days;
    }

    function tokenize(text){
      const clean = stripDiacritics(text.toLowerCase());
      return clean.replace(/[^a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼0-9\s]/gi,' ').split(/\s+/).filter(Boolean).filter(w=>!TURKISH_STOP.has(w));
    }

    function stripDiacritics(str){
      const map = {'Ã§':'c','ÄŸ':'g','Ä±':'i','Ã¶':'o','ÅŸ':'s','Ã¼':'u'};
      return str.replace(/[Ã§ÄŸÄ±Ã¶ÅŸÃ¼]/g,m=>map[m]).replace(/[Ã‡ÄžÄ°Ã–ÅžÃœ]/g,m=>map[m.toLowerCase()]);
    }

    function normalizeText(str){
      return stripDiacritics(stripUrls((str||'').toLowerCase()));
    }

    function extractEmojiTokens(text){
      const seg = new Intl.Segmenter('tr', { granularity: 'grapheme' });
      const tokens = [];
      for(const {segment} of seg.segment(text||'')){
        if(isEmojiCluster(segment)) tokens.push(segment);
      }
      return tokens;
    }

    function isEmojiCluster(cluster){
      if(!cluster) return false;
      const pict = /\p{Extended_Pictographic}/u;
      return pict.test(cluster) || /\u200d|\ufe0f/.test(cluster);
    }

    function computeAnalytics(messages, range, stickerIndex){
      const included = messages.filter(m=>m.kind!=='system'&&m.kind!=='deleted');
      const textMessages = included.filter(m=>m.kind==='text');
      const countsBySender = {'Murat Kar':0,'RÃ¼meysa Akbulut':0};
      const kindsCount = {};
      const daily = new Map();
      const monthly = new Map();
      const hourly = new Array(24).fill(0);
      const weekDay = new Array(7).fill(0);
      const longest = {'Murat Kar':[], 'RÃ¼meysa Akbulut':[]};
      const replyIntervals=[]; const replyIntervalsRaw=[]; const replyDetails=[];
      const daySet = bucketRange(range);
      daySet.forEach(d=>daily.set(dayKey(d),0));
      const callDurations={voice:0,video:0};
      const callCounts={voice:0,video:0,missedVoice:0,missedVideo:0};
      const missedBySender={'Murat Kar':0,'RÃ¼meysa Akbulut':0};
      const mediaCounts={photo:0,video:0,audio:0,sticker:0};

      for(const m of included){
        countsBySender[m.sender]=(countsBySender[m.sender]||0)+1;
        kindsCount[m.kind]=(kindsCount[m.kind]||0)+1;
        const dk = dayKey(m.ts); daily.set(dk,(daily.get(dk)||0)+1);
        const mk = monthKey(m.ts); monthly.set(mk,(monthly.get(mk)||0)+1);
        hourly[hourOfDay(m.ts)]++;
        weekDay[weekday(m.ts)]++;
        if(m.kind==='text'){
          const lengthChars = stripUrls(m.rawText).length;
          const lengthWords = tokenize(m.rawText).length;
          longest[m.sender].push({text:m.rawText, chars:lengthChars, words:lengthWords, ts:m.ts});
        }
        if(m.kind.startsWith('call')){
          if(m.kind==='call_voice_answered'){ callCounts.voice++; callDurations.voice+=parseDuration(m.rawText); }
          if(m.kind==='call_video_answered'){ callCounts.video++; callDurations.video+=parseDuration(m.rawText); }
          if(m.kind==='call_voice_missed'){ callCounts.missedVoice++; missedBySender[m.sender]++; }
          if(m.kind==='call_video_missed'){ callCounts.missedVideo++; missedBySender[m.sender]++; }
        }
        if(mediaCounts[m.kind]!==undefined) mediaCounts[m.kind]++;
      }

      let lastSender=null; let lastRunStart=null; let lastMsg=null;
      for(const m of included){
        if(m.sender!==lastSender){
          if(lastRunStart){
            const diff=(m.ts - lastRunStart)/1000;
            replyIntervalsRaw.push(diff);
            const capped=Math.min(diff, 12*3600);
            replyIntervals.push(capped);
            replyDetails.push({from:lastSender, to:m.sender, start:lastRunStart, end:m.ts, raw:diff, prev:lastMsg?lastMsg.rawText:'' , reply:m.rawText});
          }
          lastSender=m.sender; lastRunStart=m.ts; lastMsg=m;
        }
      }

      const bothDay = new Set();
      const perDaySender = new Map();
      for(const m of included){
        const k = dayKey(m.ts);
        const val = perDaySender.get(k)||{M:false,R:false};
        if(m.sender==='Murat Kar') val.M=true; else val.R=true;
        perDaySender.set(k,val);
      }
      for(const [k,v] of perDaySender.entries()) if(v.M&&v.R) bothDay.add(k);
      const streaks=[]; let currentStreak=null; for(const d of daySet){ const key=dayKey(d); const active=bothDay.has(key); if(active){ if(!currentStreak) currentStreak={start:new Date(d), end:new Date(d), len:1}; else { currentStreak.len++; currentStreak.end=new Date(d);} } else { if(currentStreak){ streaks.push(currentStreak); currentStreak=null; } } }
      if(currentStreak) streaks.push(currentStreak);
      const longestStreak = streaks.sort((a,b)=>b.len-a.len||a.start-b.start)[0]||{len:0};
      const streakBreaks = streaks.map(s=>({date:new Date(s.end.getFullYear(), s.end.getMonth(), s.end.getDate()+1), len:s.len}));

      for(const k of Object.keys(longest)){
        longest[k] = longest[k].sort((a,b)=>b.chars-a.chars).slice(0,5);
      }

      const avgChars = textMessages.length ? Math.round(textMessages.reduce((a,b)=>a+stripUrls(b.rawText).length,0)/textMessages.length) : 0;
      const avgWords = textMessages.length ? Math.round(textMessages.reduce((a,b)=>a+tokenize(b.rawText).length,0)/textMessages.length) : 0;

      const hist = bucketReply(replyIntervals);
      const meanReply = replyIntervals.length? replyIntervals.reduce((a,b)=>a+b,0)/replyIntervals.length : 0;
      const medianReply = replyIntervals.length? (replyIntervals.slice().sort((a,b)=>a-b)[Math.floor(replyIntervals.length/2)]) : 0;

      const outliers = replyDetails.sort((a,b)=>b.raw-a.raw).slice(0,10);

      const dayEntries = Array.from(daily.entries()).map(([k,v])=>({key:k,count:v}));
      const busiest = dayEntries.slice().sort((a,b)=>b.count-a.count||a.key.localeCompare(b.key)).slice(0,10);
      const calmest = dayEntries.slice().sort((a,b)=>a.count-b.count||a.key.localeCompare(b.key)).slice(0,10);

      const stickerGroups = computeStickers(included, stickerIndex);

      const wordFreq = new Map();
      for(const m of textMessages){
        const tokens = tokenize(stripUrls(m.rawText));
        tokens.forEach(t=>{ const norm=stripDiacritics(t); wordFreq.set(norm,(wordFreq.get(norm)||{count:0,forms:new Map()})); const entry=wordFreq.get(norm); entry.count++; const form= t; entry.forms.set(form,(entry.forms.get(form)||0)+1); });
      }
      const wordCloud = Array.from(wordFreq.entries()).map(([norm,obj])=>{ const bestForm = Array.from(obj.forms.entries()).sort((a,b)=>b[1]-a[1]||b[0].length-a[0].length)[0]?.[0]||norm; return {word:bestForm,count:obj.count}; }).sort((a,b)=>b.count-a.count).slice(0,240);

      const emojiFreq = new Map();
      for(const m of textMessages){
        const matches = extractEmojiTokens(m.rawText);
        matches.forEach(e=>emojiFreq.set(e,(emojiFreq.get(e)||0)+1));
      }
      const emojiTop = Array.from(emojiFreq.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const emojiDebug=[];
      for(const m of textMessages){
        const tokens = extractEmojiTokens(m.rawText);
        for(const t of tokens){ if(emojiDebug.length<20) emojiDebug.push(t); }
        if(emojiDebug.length>=20) break;
      }

      const topicCounts={};
      const topicSamples={};
      for(const [cat,kw] of Object.entries(TOPIC_CATS)){ topicCounts[cat]=0; topicSamples[cat]={m:null,r:null}; }
      for(const m of textMessages){
        const norm = normalizeText(m.rawText);
        for(const [cat,kw] of Object.entries(TOPIC_CATS)){
          if(kw.some(token=> norm.includes(token))){
            topicCounts[cat]++;
            if(m.sender==='Murat Kar' && !topicSamples[cat].m) topicSamples[cat].m=m;
            if(m.sender==='RÃ¼meysa Akbulut' && !topicSamples[cat].r) topicSamples[cat].r=m;
          }
        }
      }

      const ngramCounts = new Map();
      const ngramExamples = new Map();
      for(const m of textMessages){
        const tokens = tokenize(stripUrls(m.rawText));
        for(let n=2;n<=3;n++){
          for(let i=0;i<=tokens.length-n;i++){
            const slice=tokens.slice(i,i+n);
            const hasMeaning = slice.some(t=>t.length>=4 && !TURKISH_STOP.has(stripDiacritics(t)));
            if(!hasMeaning) continue;
            const key=slice.join(' ');
            ngramCounts.set(key,(ngramCounts.get(key)||0)+1);
            if(!ngramExamples.has(key)) ngramExamples.set(key, m);
          }
        }
      }
      const topNgramsRaw = Array.from(ngramCounts.entries()).filter(([,c])=>c>=40).sort((a,b)=>b[1]-a[1]).slice(0,12);
      const topNgrams = topNgramsRaw.length>=6 ? topNgramsRaw.map(([k,v])=>({key:k,count:v,example:ngramExamples.get(k)})) : [];

      const laughRanking=[];
      let lastBurst={M:null,R:null};
      for(const m of textMessages){
        if(!looksLikeLaugh(m.rawText)) continue;
        const senderKey = m.sender==='Murat Kar'?'M':'R';
        const last = lastBurst[senderKey];
        if(last && (m.ts - last.ts) <= 120000){
          last.messages.push(m);
          continue;
        }
        const prev = included.findLast(x=>x.ts<m.ts && x.sender!==m.sender && x.kind==='text');
        if(prev){
          const score = scoreLaughBurst(m.rawText);
          const entry = laughRanking.find(x=>x.msg===prev);
          if(entry){ entry.count += score; entry.laughs.push(m.rawText); }
          else laughRanking.push({msg:prev,count:score,laughs:[m.rawText],ts:m.ts});
          lastBurst[senderKey] = {ts:m.ts, messages:[m]};
        }
      }
      laughRanking.sort((a,b)=>b.count-a.count).splice(20);

      const romanceMessages = textMessages.filter(m=>ROMANTIC.some(r=>m.rawText.toLowerCase().includes(r)) || /â¤ï¸|ðŸ’œ|ðŸ’•|ðŸ’–|ðŸ’˜/.test(m.rawText)).sort((a,b)=>b.rawText.length-a.rawText.length).slice(0,10);

      const dateMentions=[]; const dateCats=new Map(); const dateWeek=new Map();
      for(const m of textMessages){
        const norm = stripDiacritics(m.rawText.toLowerCase());
        if(DATEI_TOKENS.some(t=>norm.includes(t))){
          dateMentions.push(m);
          const parts = tokenize(norm);
          const idx = parts.findIndex(p=>DATEI_TOKENS.includes(p));
          const cat = idx>0?parts[idx-1]:'genel';
          dateCats.set(cat,(dateCats.get(cat)||0)+1);
          const wk = weekKey(m.ts); dateWeek.set(wk.key,(dateWeek.get(wk.key)||0)+1);
        }
      }

      const overlay = buildOverlay(daily, laughRanking, romanceMessages, dateWeek);

      return {countsBySender,kindsCount,daily,monthly,hourly,weekDay,longest,replyIntervals,replyIntervalsRaw,replyDetails,hist,meanReply,medianReply,outliers,busiest,calmest,mediaCounts,callCounts,callDurations,missedBySender,stickerGroups,wordCloud,emojiTop,emojiDebug,topicCounts,topicSamples,topNgrams,laughRanking,romanceMessages,dateMentions,dateCats,dateWeek:fillWeek(dateWeek),weeklyOverlay:overlay,longestStreak,streaks,streakBreaks,avgChars,avgWords,range};
    }

    function fillWeek(map){
      const arr = Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
      return new Map(arr);
    }

    function parseDuration(text){
      const m = text.match(/(\d+) saat/) || [];
      const h = Number(m[1]||0);
      const m2 = text.match(/(\d+) dk/) || [];
      const min = Number(m2[1]||0);
      const s = text.match(/(\d+) sn/) || [];
      const sec = Number(s[1]||0);
      return h*3600 + min*60 + sec;
    }

    function bucketReply(list){
      const buckets=[0,0,0,0,0,0,0,0];
      list.forEach(sec=>{
        if(sec<=30) buckets[0]++; else if(sec<=60) buckets[1]++; else if(sec<=300) buckets[2]++; else if(sec<=900) buckets[3]++; else if(sec<=3600) buckets[4]++; else if(sec<=10800) buckets[5]++; else if(sec<=36000) buckets[6]++; else buckets[7]++;
      });
      return buckets;
    }

    async function buildStickerIndex(files){
      const stickers = files.filter(f=>/STICKER-.*\.webp$/i.test(f.name));
      const res=[];
      for(const f of stickers){
        const buf = await f.arrayBuffer();
        const hash = await crypto.subtle.digest('SHA-256', buf);
        const view = new Uint8Array(hash).slice(0,4);
        const hex = Array.from(view).map(x=>x.toString(16).padStart(2,'0')).join('');
        res.push({name:f.name, size:f.size, hash:hex});
      }
      return res;
    }

    function computeStickers(messages, index){
      const groups=new Map();
      for(const m of messages){
        if(m.kind!=='sticker') continue;
        const match = m.rawText.match(/<([^>]*-STICKER-[^>]*)>/);
        const file = match?match[1]:'';
        const meta = index.find(i=>file.includes(i.name));
        const key = meta? `${meta.size} bayt${meta.hash?` â€¢ ${meta.hash}`:''}` : 'Sticker';
        const arr = groups.get(key)||{key,label:'',count:0,samples:[]};
        arr.count++; if(arr.samples.length<3) arr.samples.push(m);
        groups.set(key,arr);
      }
      return Array.from(groups.values()).sort((a,b)=>b.count-a.count);
    }

    function enrichStickerLabels(groups){
      return (groups||[]).map(g=>{
        const stored = STORAGE.getItem('label_'+g.key);
        const label = stored!==null ? stored : (g.label||'');
        return {...g, label};
      });
    }

    function buildOverlay(daily, laughs, romance, dateWeek){
      const byWeek = new Map();
      for(const [k,v] of daily.entries()){
        const dParts = k.split('-');
        const ts = new Date(Number(dParts[0]), Number(dParts[1])-1, Number(dParts[2]));
        const wk = weekKey(ts).key;
        byWeek.set(wk,(byWeek.get(wk)||{msg:0,laugh:0,rom:0,datei:0}));
        byWeek.get(wk).msg += v;
      }
      laughs.forEach(l=>{ const wk = weekKey(l.msg.ts).key; byWeek.set(wk,(byWeek.get(wk)||{msg:0,laugh:0,rom:0,datei:0})); byWeek.get(wk).laugh += l.count; });
      romance.forEach(r=>{ const wk = weekKey(r.ts).key; byWeek.set(wk,(byWeek.get(wk)||{msg:0,laugh:0,rom:0,datei:0})); byWeek.get(wk).rom += 1; });
      dateWeek.forEach((v,k)=>{ byWeek.set(k,(byWeek.get(k)||{msg:0,laugh:0,rom:0,datei:0})); byWeek.get(k).datei += v; });
      const arr = Array.from(byWeek.entries()).map(([k,v])=>({key:k,...v})).sort((a,b)=>a.key.localeCompare(b.key));
      const normField = f=>{ const max = Math.max(...arr.map(a=>a[f]||0),1); arr.forEach(a=>{ a[f+'Norm']= Math.round((a[f]||0)/max*100); }); };
      ['msg','laugh','rom','datei'].forEach(normField);
      return arr;
    }

    function formatDuration(sec){
      const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); const s=Math.floor(sec%60);
      if(h>0) return `${h} saat ${m} dk`;
      if(m>0) return `${m} dk ${s} sn`;
      return `${s} sn`;
    }

    function formatRatio(part, total){
      const t = Number(total)||0;
      if(!t) return '0% (0)';
      const p = Number(part)||0;
      return `${Math.round(p/t*100)}% (${p})`;
    }

    function truncate(str, len){
      if(!str) return '';
      return str.length>len ? str.slice(0,len-1)+'â€¦' : str;
    }

    function renderAll(parsed, agg){
      contentEl.innerHTML='';
      navEl.innerHTML='';
      const rangeText = parsed.range.min? `${dayKey(parsed.range.min)} â€” ${dayKey(parsed.range.max)}` : 'Tarih yok';
      const pages=[];

      pages.push({id:'page-1',html:`
        <section class="page cover" style="background:linear-gradient(135deg,#ffe3f3,#e6e9ff);display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-end;">
          <div class="pill">WhatsApp 2025 Wrapped</div>
          <h1 class="page-title" style="font-size:32px;">Murat â™¥ RÃ¼meysa â€” 2025 Wrapped</h1>
          <p class="page-sub">${rangeText}</p>
          <p class="muted">Birlikte geÃ§en mesajlÄ± yÄ±lÄ±n sakin ve romantik Ã¶zeti</p>
        </section>`});

      const total = (agg.countsBySender['Murat Kar']||0) + (agg.countsBySender['RÃ¼meysa Akbulut']||0);
      const kpis = [
        {label:'Toplam mesaj',value:total,desc:'TÃ¼m sohbet akÄ±ÅŸÄ±'},
        {label:'Murat mesaj',value:agg.countsBySender['Murat Kar']||0,desc:'GÃ¶nderilen'},
        {label:'RÃ¼meysa mesaj',value:agg.countsBySender['RÃ¼meysa Akbulut']||0,desc:'GÃ¶nderilen'},
        {label:'Foto/Video/Ses/Sticker',value:`${agg.mediaCounts.photo||0}/${agg.mediaCounts.video||0}/${agg.mediaCounts.audio||0}/${agg.mediaCounts.sticker||0}`,desc:'Medya adedi'},
        {label:'YanÄ±t sÃ¼resi ort.',value:formatDuration(agg.meanReply),desc:'Run tabanlÄ±'},
        {label:'YanÄ±t sÃ¼resi medyan',value:formatDuration(agg.medianReply),desc:''},
        {label:'En uzun streak',value:`${agg.longestStreak.len||0} gÃ¼n`,desc: agg.longestStreak.start?`${dayKey(agg.longestStreak.start)} â†’ ${dayKey(agg.longestStreak.end)}`:''},
        {label:'Ã‡aÄŸrÄ± sÃ¼resi',value:`${formatDuration(agg.callDurations.voice+agg.callDurations.video)}`,desc:`${agg.callCounts.voice+agg.callCounts.video} yanÄ±tlanan`},
        {label:'Kahkaha anÄ±',value:agg.laughRanking.length,desc:'Top 20 listesi'},
      ];
      pages.push({id:'page-2',html:`
        <section class="page" id="summary">
          <div class="page-header"><div><div class="pill">Sayfa 2</div><h2 class="page-title">Ã–zet Pano</h2><p class="page-sub">YÄ±lÄ±n ana rakamlarÄ±</p></div></div>
          <div class="grid">
            ${kpis.map(k=>`<div class="card" style="grid-column: span 4;" ><h3>${k.label}</h3><div class="kpi">${k.value}</div><div class="muted">${k.desc}</div></div>`).join('')}
          </div>
        </section>`});

      const trafficInsights = [
        `En yoÄŸun gÃ¼n: ${agg.busiest[0]?`${agg.busiest[0].key} (${agg.busiest[0].count})`:''}`,
        `HaftalÄ±k ortalama: ${Math.round(total/Math.max(agg.daily.size,1))} mesaj/gÃ¼n`,
        `Ay ortalamasÄ±: ${Math.round(total/Math.max(agg.monthly.size,1))} mesaj/ay`
      ];
      pages.push({id:'page-3',html:`
        <section class="page" id="tempo">
          <div class="page-header"><div><div class="pill">Sayfa 3</div><h2 class="page-title">Tempo</h2><p class="page-sub">GÃ¼nlÃ¼k mesaj trafiÄŸi</p></div></div>
          <div class="chart-box avoid-break"><canvas data-type="line"></canvas></div>
          <ul class="list" style="margin-top:12px;">
            ${trafficInsights.map(t=>`<li>${t}</li>`).join('')}
          </ul>
        </section>`});

      const topMonths = Array.from(agg.monthly.entries()).sort((a,b)=>b[1]-a[1]).slice(0,3);
      pages.push({id:'page-4',html:`
        <section class="page" id="months">
          <div class="page-header"><div><div class="pill">Sayfa 4</div><h2 class="page-title">Aylara GÃ¶re</h2><p class="page-sub">12 aylÄ±k ritim</p></div></div>
          <div class="chart-box avoid-break"><canvas data-type="month"></canvas></div>
          <div class="two-col" style="margin-top:12px;">
            <div class="card"><h3>En yoÄŸun aylar</h3><ul class="list">${topMonths.map(m=>`<li>${m[0]} â€” ${m[1]}</li>`).join('')}</ul></div>
            <div class="card"><h3>YÄ±llÄ±k toplam</h3><div class="kpi">${total}</div><div class="muted">mesaj</div></div>
          </div>
        </section>`});

      const peakHour = agg.hourly.indexOf(Math.max(...agg.hourly));
      const lowHour = agg.hourly.indexOf(Math.min(...agg.hourly));
      pages.push({id:'page-5',html:`
        <section class="page" id="hours">
          <div class="page-header"><div><div class="pill">Sayfa 5</div><h2 class="page-title">Saatler</h2><p class="page-sub">GÃ¼nÃ¼n hangi saatlerinde?</p></div></div>
          <div class="chart-box avoid-break"><canvas data-type="hours"></canvas></div>
          <div class="two-col" style="margin-top:12px;">
            <div class="card"><h3>Zirve saat</h3><div class="kpi">${peakHour}:00</div><div class="muted">En yoÄŸun dilim</div></div>
            <div class="card"><h3>En sakin saat</h3><div class="kpi">${lowHour}:00</div><div class="muted">Neredeyse sessizlik</div></div>
          </div>
        </section>`});

      const weekNames=['Pzt','Sal','Ã‡ar','Per','Cum','Cts','Paz'];
      const peakDayIdx = agg.weekDay.indexOf(Math.max(...agg.weekDay));
      const calmDayIdx = agg.weekDay.indexOf(Math.min(...agg.weekDay));
      pages.push({id:'page-6',html:`
        <section class="page" id="weekdays">
          <div class="page-header"><div><div class="pill">Sayfa 6</div><h2 class="page-title">GÃ¼nler</h2><p class="page-sub">HaftanÄ±n ritmi</p></div></div>
          <div class="chart-box avoid-break"><canvas data-type="week"></canvas></div>
          <div class="two-col" style="margin-top:12px;">
            <div class="card"><h3>En hareketli gÃ¼n</h3><div class="kpi">${weekNames[peakDayIdx]}</div><div class="muted">HaftanÄ±n yÄ±ldÄ±zÄ±</div></div>
            <div class="card"><h3>En sakin gÃ¼n</h3><div class="kpi">${weekNames[calmDayIdx]}</div><div class="muted">Dinlenme modu</div></div>
          </div>
        </section>`});

      const fastestPct = Math.round((agg.hist[0]+agg.hist[1])/Math.max(agg.replyIntervals.length,1)*100);
      const slowestPct = Math.round((agg.hist[6]+agg.hist[7])/Math.max(agg.replyIntervals.length,1)*100);
      const topOutliers = agg.outliers.slice(0,5);
      pages.push({id:'page-7',html:`
        <section class="page" id="reply">
          <div class="page-header"><div><div class="pill">Sayfa 7</div><h2 class="page-title">YanÄ±t SÃ¼resi</h2><p class="page-sub">12 saat tavanlÄ± histogram</p></div></div>
          <div class="chart-box avoid-break"><canvas data-type="hist"></canvas></div>
          <div class="grid" style="margin-top:12px;">
            <div class="card" style="grid-column: span 4;"><h3>Ortalama</h3><div class="kpi">${formatDuration(agg.meanReply)}</div></div>
            <div class="card" style="grid-column: span 4;"><h3>Medyan</h3><div class="kpi">${formatDuration(agg.medianReply)}</div></div>
            <div class="card" style="grid-column: span 4;"><h3>En hÄ±zlÄ± dilim</h3><div class="kpi">${fastestPct}%</div><div class="muted">ilk 1 dak.</div></div>
            <div class="card" style="grid-column: span 4;"><h3>En yavaÅŸ dilim</h3><div class="kpi">${slowestPct}%</div><div class="muted">3s-12s</div></div>
            <div class="card avoid-break" style="grid-column: span 8;"><h3>Top 5 en uzun bekleyiÅŸ</h3><ul class="list">${topOutliers.map((o,i)=>`<li class="${i>=5?'print-trim extra':''}">${dayKey(o.start)} â†’ ${dayKey(o.end)} (${formatDuration(o.raw)}) â€” ${truncate(escapeHtml(o.prev||''),160)}</li>`).join('')}</ul></div>
          </div>
        </section>`});

      const streakTop = agg.streaks.slice().sort((a,b)=>b.len-a.len||a.start-b.start).slice(0,5);
      const breakTop = agg.streakBreaks.slice(0,5);
      pages.push({id:'page-8',html:`
        <section class="page" id="streaks">
          <div class="page-header"><div><div class="pill">Sayfa 8</div><h2 class="page-title">Streakler</h2><p class="page-sub">Birlikte yazÄ±lan gÃ¼nler</p></div></div>
          <div class="card avoid-break" style="margin-bottom:12px;">
            <h3>En uzun streak</h3>
            <div class="kpi">${agg.longestStreak.len||0} gÃ¼n</div>
            <div class="muted">${agg.longestStreak.start?`${dayKey(agg.longestStreak.start)} â†’ ${dayKey(agg.longestStreak.end)}`:''}</div>
          </div>
          <div class="two-col">
            <div class="card"><h3>Top 5 streak</h3><ul class="list">${streakTop.map((s,i)=>`<li class="${i>=5?'print-trim extra':''}">${dayKey(s.start)} â†’ ${dayKey(s.end)} (${s.len} gÃ¼n)</li>`).join('')}</ul></div>
            <div class="card"><h3>Streak kÄ±rÄ±lma gÃ¼nleri</h3><ul class="list">${breakTop.map((b,i)=>`<li class="${i>=5?'print-trim extra':''}">${dayKey(b.date)} (Ã¶nce ${b.len}g)</li>`).join('')}</ul></div>
          </div>
        </section>`});

      pages.push({id:'page-9',html:`
        <section class="page" id="busycalm">
          <div class="page-header"><div><div class="pill">Sayfa 9</div><h2 class="page-title">En YoÄŸun / En Sakin GÃ¼nler</h2><p class="page-sub">GÃ¶z aÃ§Ä±p kapayÄ±nca</p></div></div>
          <div class="two-col">
            <div class="card"><h3>En yoÄŸun 7 gÃ¼n</h3><ul class="list">${agg.busiest.slice(0,7).map(d=>`<li>${d.key} â€” ${d.count}</li>`).join('')}</ul><p class="note">Not:</p></div>
            <div class="card"><h3>En sakin 7 gÃ¼n</h3><ul class="list">${agg.calmest.slice(0,7).map(d=>`<li>${d.key} â€” ${d.count}</li>`).join('')}</ul><p class="note">Not:</p></div>
          </div>
        </section>`});

      const topWords = agg.wordCloud.slice(0,10);
      pages.push({id:'page-10',html:`
        <section class="page" id="wordcloud">
          <div class="page-header"><div><div class="pill">Sayfa 10</div><h2 class="page-title">Kelime Bulutu</h2><p class="page-sub">En Ã§ok konuÅŸulan kelimeler</p></div></div>
          <div class="card avoid-break" style="min-height:260px;">
            <div class="word-cloud-frame">
              <canvas id="wordCloudCanvas" data-type="wordcloud"></canvas>
            </div>
            <div class="word-cloud-hint">Koyu fonda yÃ¼ksek Ã§Ã¶zÃ¼nÃ¼rlÃ¼klÃ¼, baskÄ± dostu kelime bulutu.</div>
          </div>
          <div class="two-col" style="margin-top:12px;">
            <div class="card"><h3>Top 10 kelime</h3><ul class="list two-col-list">${topWords.map((w,i)=>`<li class="${i>=7?'print-trim extra':''}">${w.word} â€” ${w.count}</li>`).join('')}</ul></div>
            <div class="card"><h3>KÄ±sa not</h3><p class="muted">Daha fazla kelime ekran gÃ¶rÃ¼nÃ¼mÃ¼nde gÃ¶rÃ¼lebilir.</p></div>
          </div>
        </section>`});

      pages.push({id:'page-11',html:`
        <section class="page" id="emoji">
          <div class="page-header"><div><div class="pill">Sayfa 11</div><h2 class="page-title">Emojiler</h2><p class="page-sub">Top 10 ifade</p></div></div>
          <div class="emoji-list">
            ${agg.emojiTop.map((e,i)=>`<div class="card emoji-item ${i>=7?'print-trim extra':''}"><div>${e[0]}</div><div class="muted">${e[1]} kez</div></div>`).join('')}
          </div>
        </section>`});

      const topicEntries = Object.entries(agg.topicCounts).sort((a,b)=>b[1]-a[1]);
      pages.push({id:'page-12',html:`
        <section class="page" id="topics">
          <div class="page-header"><div><div class="pill">Sayfa 12</div><h2 class="page-title">Temalar</h2><p class="page-sub">10â€“12 kategori</p></div></div>
          <div class="grid">
            ${topicEntries.map(([k,v],i)=>`<div class="card ${i>=12?'print-trim extra':''}" style="grid-column: span 4;"><h3>${k}</h3><div class="kpi">${v}</div><p class="muted">mesaj</p><div class="note">Murat: ${agg.topicSamples[k].m?truncate(escapeHtml(agg.topicSamples[k].m.rawText),160):'-'}</div><div class="note">RÃ¼meysa: ${agg.topicSamples[k].r?truncate(escapeHtml(agg.topicSamples[k].r.rawText),160):'-'}</div></div>`).join('')}
          </div>
        </section>`});

      if(agg.topNgrams && agg.topNgrams.length){
        pages.push({id:'page-13',html:`
          <section class="page" id="bonus">
            <div class="page-header"><div><div class="pill">Sayfa 13</div><h2 class="page-title">Bu yÄ±lÄ±n en Ã§ok konuÅŸulan 12 kalÄ±bÄ±</h2><p class="page-sub">AnlamlÄ± bigram/trigram</p></div></div>
            <div class="card avoid-break">
              <ul class="list">${agg.topNgrams.map((n,i)=>`<li class="${i>=7?'print-trim extra':''}">${n.key} â€” ${n.count}${n.example?`<div class=\"muted\">${truncate(escapeHtml(n.example.rawText),140)}</div>`:''}</li>`).join('')}</ul>
            </div>
          </section>`});
      }

      const laughTop = agg.laughRanking.slice(0,8);
      pages.push({id:'page-14',html:`
        <section class="page" id="laughter">
          <div class="page-header"><div><div class="pill">Sayfa 14</div><h2 class="page-title">Kahkaha</h2><p class="page-sub">En Ã§ok gÃ¼lÃ¼nen mesajlar</p></div></div>
          <div class="grid">
            ${laughTop.map((l,i)=>`<div class="card ${i>=8?'print-trim extra':''}" style="grid-column: span 6;">
              <h3>${i+1}. ${l.count} kahkaha</h3>
              <p>${truncate(escapeHtml(l.msg.rawText),220)}</p>
              <p class="note">${l.laughs.slice(0,2).map(x=>truncate(escapeHtml(x),80)).join('<br>')}</p>
            </div>`).join('')}
          </div>
          <details class="no-print" style="margin-top:12px;">
            <summary>TÃ¼m 20 satÄ±rÄ± gÃ¶ster</summary>
            <div class="grid">${agg.laughRanking.map((l,i)=>`<div class="card" style="grid-column: span 6;"><h4>${i+1}. ${l.count} kahkaha</h4><p>${escapeHtml(l.msg.rawText)}</p></div>`).join('')}</div>
          </details>
        </section>`});

      const romanceTop = agg.romanceMessages.slice(0,6);
      pages.push({id:'page-15',html:`
        <section class="page" id="romance">
          <div class="page-header"><div><div class="pill">Sayfa 15</div><h2 class="page-title">Romantizm</h2><p class="page-sub">En tatlÄ± 10 an (baskÄ±da 6)</p></div></div>
          <div class="grid">
            ${romanceTop.map((m,i)=>`<div class="card" style="grid-column: span 6;"><h3>${i+1}. An</h3><p>${truncate(escapeHtml(m.rawText),240)}</p><div class="muted">${dayKey(m.ts)}</div></div>`).join('')}
          </div>
          <details class="no-print" style="margin-top:12px;">
            <summary>TÃ¼m 10 anÄ± gÃ¶ster</summary>
            <ul class="list">${agg.romanceMessages.map(m=>`<li>${escapeHtml(m.rawText)}</li>`).join('')}</ul>
          </details>
        </section>`});

      pages.push({id:'page-16',html:`
        <section class="page" id="calls">
          <div class="page-header"><div><div class="pill">Sayfa 16</div><h2 class="page-title">Ã‡aÄŸrÄ±lar & Medya</h2><p class="page-sub">KPI kartlarÄ±</p></div></div>
          <div class="grid">
            ${[['FotoÄŸraf',agg.mediaCounts.photo,'#ec4899'],['Video',agg.mediaCounts.video,'#6366f1'],['Ses',agg.mediaCounts.audio,'#22c55e'],['Sticker',agg.mediaCounts.sticker,'#f59e0b']].map(k=>`<div class="card" style="grid-column: span 3;">
              <div class="muted">${k[0]}</div><div class="kpi" style="color:${k[2]};">${k[1]||0}</div>
            </div>`).join('')}
          </div>
          <div class="grid" style="margin-top:12px;">
            <div class="card" style="grid-column: span 4;">
              <h3>Sesli yanÄ±tlanan</h3>
              <div class="kpi">${agg.callCounts.voice||0}</div>
              <div class="muted">Toplam sÃ¼re: ${formatDuration(agg.callDurations.voice)}</div>
            </div>
            <div class="card" style="grid-column: span 4;">
              <h3>GÃ¶rÃ¼ntÃ¼lÃ¼ yanÄ±tlanan</h3>
              <div class="kpi">${agg.callCounts.video||0}</div>
              <div class="muted">Toplam sÃ¼re: ${formatDuration(agg.callDurations.video)}</div>
            </div>
            <div class="card" style="grid-column: span 4;">
              <h3>CevapsÄ±z</h3>
              <div class="kpi">${agg.callCounts.missedVoice+agg.callCounts.missedVideo}</div>
              <div class="muted">Sesli: ${agg.callCounts.missedVoice||0} â€¢ GÃ¶rÃ¼ntÃ¼lÃ¼: ${agg.callCounts.missedVideo||0}</div>
            </div>
          </div>
          <div class="grid" style="margin-top:12px;">
            <div class="card" style="grid-column: span 4;">
              <h4>CevapsÄ±zlarÄ±n oranÄ±</h4>
              <p>Murat baÅŸlattÄ±: ${formatRatio(agg.missedBySender?.['Murat Kar'], agg.callCounts.missedVoice+agg.callCounts.missedVideo)}</p>
              <p>RÃ¼meysa baÅŸlattÄ±: ${formatRatio(agg.missedBySender?.['RÃ¼meysa Akbulut'], agg.callCounts.missedVoice+agg.callCounts.missedVideo)}</p>
            </div>
            <div class="card" style="grid-column: span 4;">
              <h4>Murat aramalarÄ±nÄ±n cevapsÄ±z oranÄ±</h4>
              <p>${formatRatio(agg.missedBySender?.['Murat Kar'], (agg.callCounts.voice+agg.callCounts.video+agg.callCounts.missedVoice+agg.callCounts.missedVideo)/2)}</p>
            </div>
            <div class="card" style="grid-column: span 4;">
              <h4>RÃ¼meysa aramalarÄ±nÄ±n cevapsÄ±z oranÄ±</h4>
              <p>${formatRatio(agg.missedBySender?.['RÃ¼meysa Akbulut'], (agg.callCounts.voice+agg.callCounts.video+agg.callCounts.missedVoice+agg.callCounts.missedVideo)/2)}</p>
            </div>
          </div>
        </section>`});

      const dateCatsSorted = Array.from(agg.dateCats.entries()).sort((a,b)=>b[1]-a[1]).slice(0,8);
      pages.push({id:'page-17',html:`
        <section class="page" id="datei">
          <div class="page-header"><div><div class="pill">Sayfa 17</div><h2 class="page-title">Dateâ€™i</h2><p class="page-sub">KonuÅŸtuÄŸumuz dateâ€™ler</p></div></div>
          <div class="grid">
            <div class="card" style="grid-column: span 5;"><h3>Toplam</h3><div class="kpi">${agg.dateMentions.length}</div><div class="muted">adet geÃ§iÅŸ</div><h4>Ä°lk 8 kategori</h4><ul class="list">${dateCatsSorted.map((c,i)=>`<li class="${i>=7?'print-trim extra':''}">${c[0]} â€” ${c[1]}</li>`).join('')}</ul></div>
            <div class="card avoid-break" style="grid-column: span 7;"><h3>HaftalÄ±k yoÄŸunluk</h3><canvas data-type="dateweek"></canvas></div>
          </div>
        </section>`});

      pages.push({id:'page-18',html:`
        <section class="page" id="overlay">
          <div class="page-header"><div><div class="pill">Sayfa 18</div><h2 class="page-title">BÃ¼yÃ¼k Final Overlay</h2><p class="page-sub">HaftalÄ±k normalizasyon (0â€“100)</p></div></div>
          <div class="chart-box avoid-break"><canvas data-type="overlay"></canvas></div>
          <ul class="list" style="margin-top:12px;">
            <li>Trafik, kahkaha, romantizm ve dateâ€™i yoÄŸunluÄŸu aynÄ± eksende.</li>
            <li>Renkler: mesaj (#6366f1), kahkaha (#f97316), romantizm (#ec4899), dateâ€™i (#22c55e).</li>
          </ul>
        </section>`});

      const savedClosing = STORAGE.getItem('closing_note')||'Bu yÄ±lÄ± nasÄ±l kapatmak istersin? Buraya son sÃ¶zÃ¼nÃ¼ yaz.';
      pages.push({id:'page-19',html:`
        <section class="page" id="closing">
          <div class="page-header"><div><div class="pill">Sayfa 19</div><h2 class="page-title">Son SÃ¶z</h2><p class="page-sub">Ekranda dÃ¼zenle, baskÄ±da sabit</p></div></div>
          <textarea class="closing-input no-print" id="closingInput">${savedClosing}</textarea>
          <div class="card" style="margin-top:12px;"><h3>YazdÄ±rÄ±lacak metin</h3><p id="closingPreview">${escapeHtml(savedClosing)}</p></div>
        </section>`});

      pages.push({id:'page-20',html:`
        <section class="page" id="back" style="display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;">
          <div class="pill">Sayfa 20</div>
          <h2 class="page-title">ArÅŸive hazÄ±r</h2>
          <p class="muted">Yerelde Ã¼retildi. PDF olarak saklayÄ±n.</p>
        </section>`});

      latestPages = pages;
      renderPagesGradually(pages, agg);
    }

    function renderAllPagesSync(pages, agg){
      contentEl.innerHTML='';
      navEl.innerHTML='';
      pages.forEach(p=>renderSinglePage(p, agg));
    }

    function renderPagesGradually(pages, agg){
      contentEl.innerHTML='';
      navEl.innerHTML='';
      const queue = [...pages];
      const first = queue.splice(0,2);
      first.forEach(p=>renderSinglePage(p, agg));
      const schedule = window.requestIdleCallback || window.requestAnimationFrame;
      const pump = ()=>{
        const next = queue.shift();
        if(!next) return;
        renderSinglePage(next, agg);
        if(queue.length) schedule(pump);
      };
      schedule(pump);
    }

    function renderSinglePage(p, agg){
      contentEl.insertAdjacentHTML('beforeend', p.html);
      const navLabel = `S${p.id.split('-')[1]}`;
      navEl.insertAdjacentHTML('beforeend', `<a href="#${p.id}">${navLabel}</a>`);
      const section = document.getElementById(p.id);
      hydrateSection(section, agg);
    }

    function hydrateSection(section, agg){
      if(!section) return;
      const closingInput = section.querySelector('#closingInput');
      if(closingInput){
        closingInput.addEventListener('input',(e)=>{
          STORAGE.setItem('closing_note', e.target.value);
          const target=document.getElementById('closingPreview');
          if(target) target.textContent = e.target.value;
        });
        const target=document.getElementById('closingPreview');
        if(target) target.textContent = closingInput.value;
      }
      section.querySelectorAll('.sticker-label').forEach(inp=>{
        const stored = STORAGE.getItem('label_'+inp.dataset.key);
        if(stored!==null) inp.value = stored; else if(!inp.value && inp.dataset.label) inp.value = inp.dataset.label;
        inp.addEventListener('change',()=>{ STORAGE.setItem('label_'+inp.dataset.key, inp.value); });
      });
      section.querySelectorAll('canvas').forEach(cv=>{
        const type=cv.dataset.type;
        if(type==='line') drawLineChart(cv, agg.daily);
        else if(type==='month') drawBarChartMonth(cv, agg.monthly);
        else if(type==='hours') drawBarChartHours(cv, agg.hourly);
        else if(type==='week') drawBarChartWeekdays(cv, agg.weekDay);
        else if(type==='hist') drawHistogram(cv, agg.hist);
        else if(type==='dateweek') drawMapChart(cv, agg.dateWeek);
        else if(type==='overlay') drawOverlay(cv, agg.weeklyOverlay);
        else if(type==='wordcloud') drawWordCloud(cv, agg, 'screen');
      });
    }

    function drawWordCloud(canvas, agg, mode='screen'){
      const wordsRaw = agg?.wordCloud||[];
      if(!wordsRaw.length) return;
      const rect = canvas.getBoundingClientRect();
      const parentRect = canvas.parentElement?.getBoundingClientRect();
      const cssWidth = Math.max(rect.width||0, parentRect?.width||0, 640);
      const cssHeight = Math.max(rect.height||0, parentRect?.height||0, 260);
      const scale = Math.max(2, window.devicePixelRatio||1);
      canvas.width = Math.round(cssWidth * scale);
      canvas.height = Math.round(cssHeight * scale);
      canvas.style.width = `${cssWidth}px`;
      canvas.style.height = `${cssHeight}px`;
      const ctx = canvas.getContext('2d');
      ctx.setTransform(scale,0,0,scale,0,0);
      ctx.clearRect(0,0,cssWidth,cssHeight);
      ctx.fillStyle = '#f8f5fd';
      ctx.fillRect(0,0,cssWidth,cssHeight);

      const maxWords = mode==='print'? wordCloudConfig.maxWordsPrint : wordCloudConfig.maxWordsScreen;
      const maxFreq = wordsRaw[0]?.count || 1;
      const freqThreshold = Math.min(maxFreq, Math.max(wordCloudConfig.minFrequency, Math.floor(maxFreq*0.015)));
      const words = wordsRaw.filter(w=>w.count>=freqThreshold).slice(0, maxWords);
      if(!words.length) return;
      const minFreq = words[words.length-1].count || 1;
      const seed = deriveWordCloudSeed(agg, words);
      const rng = mulberry32(seed);
      const occW = Math.ceil(cssWidth);
      const occH = Math.ceil(cssHeight);
      const occupancy = new Uint8Array(occW*occH);
      const centerX = cssWidth/2; const centerY = cssHeight/2;
      const placements = [];
      const angleStep = 0.35;
      const baseStep = 6;

      for(const w of words){
        const fontSize = mapFreqToFont(w.count, minFreq, maxFreq);
        const wordHash = hashString(w.word);
        const allowRotate = wordCloudConfig.allowRotate;
        const rotated = allowRotate && (Math.abs(wordHash)%10 < Math.round(wordCloudConfig.rotationRatio*10));
        const glyph = buildGlyph(w.word, fontSize, rotated);
        const maxAttempts = 1400;
        let placed=false;
        for(let i=0;i<maxAttempts;i++){
          const theta = i*angleStep + rng()*0.2;
          const radius = baseStep + (4 + fontSize*0.16) * theta;
          const x = centerX + Math.cos(theta)*radius;
          const y = centerY + Math.sin(theta)*radius;
          if(!fitsGlyph(occupancy, occW, occH, x, y, glyph)) continue;
          placements.push({text:w.word, fontSize, rotate:rotated, x, y, color: WORD_CLOUD_PALETTE[Math.abs(wordHash)%WORD_CLOUD_PALETTE.length]});
          stampGlyph(occupancy, occW, occH, x, y, glyph);
          placed=true; break;
        }
        if(!placed) console.debug('Kelime yerleÅŸtirilemedi', w.word);
      }

      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.shadowColor='rgba(41,25,65,0.15)';
      ctx.shadowBlur=2;
      ctx.shadowOffsetY=1;
      placements.forEach(p=>{
        ctx.save();
        ctx.translate(p.x,p.y);
        if(p.rotate) ctx.rotate(Math.PI/2);
        ctx.fillStyle=p.color;
        ctx.font = `${p.fontSize}px ${getWordCloudFont()}`;
        ctx.lineWidth = 1;
        ctx.strokeStyle='rgba(255,255,255,0.35)';
        ctx.strokeText(p.text,0,0);
        ctx.fillText(p.text,0,0);
        ctx.restore();
      });
    }

    function mapFreqToFont(freq, minFreq, maxFreq){
      const logMin = Math.log(Math.max(minFreq,1));
      const logMax = Math.log(Math.max(maxFreq,1));
      const norm = (Math.log(Math.max(freq,1)) - logMin) / Math.max(logMax - logMin, 0.0001);
      const eased = Math.pow(Math.min(Math.max(norm,0),1), 0.65);
      return Math.max(wordCloudConfig.minFont, Math.min(wordCloudConfig.maxFont, wordCloudConfig.minFont + eased*(wordCloudConfig.maxFont - wordCloudConfig.minFont)));
    }

    function buildGlyph(text, fontSize, rotate){
      const pad = Math.ceil(fontSize*0.3);
      const tmp = document.createElement('canvas');
      const ctx = tmp.getContext('2d');
      ctx.font = `${fontSize}px ${getWordCloudFont()}`;
      const metrics = ctx.measureText(text);
      const textWidth = metrics.width;
      const textHeight = fontSize;
      const boxWidth = rotate? textHeight : textWidth;
      const boxHeight = rotate? textWidth : textHeight;
      tmp.width = Math.ceil(boxWidth + pad*2);
      tmp.height = Math.ceil(boxHeight + pad*2);
      ctx.translate(tmp.width/2, tmp.height/2);
      if(rotate) ctx.rotate(Math.PI/2);
      ctx.font = `${fontSize}px ${getWordCloudFont()}`;
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillStyle='#fff';
      ctx.fillText(text,0,0);
      const data = ctx.getImageData(0,0,tmp.width,tmp.height);
      return {data,width:tmp.width,height:tmp.height};
    }

    function fitsGlyph(occ, w, h, cx, cy, glyph){
      const startX = Math.round(cx - glyph.width/2);
      const startY = Math.round(cy - glyph.height/2);
      if(startX<0 || startY<0 || startX + glyph.width >= w || startY + glyph.height >= h) return false;
      const pixels = glyph.data.data;
      for(let y=0;y<glyph.height;y++){
        const row = (startY + y)*w + startX;
        for(let x=0;x<glyph.width;x++){
          const alpha = pixels[(y*glyph.width + x)*4 + 3];
          if(alpha>0 && occ[row + x]) return false;
        }
      }
      return true;
    }

    function stampGlyph(occ, w, h, cx, cy, glyph){
      const startX = Math.round(cx - glyph.width/2);
      const startY = Math.round(cy - glyph.height/2);
      const pixels = glyph.data.data;
      for(let y=0;y<glyph.height;y++){
        const row = (startY + y)*w + startX;
        for(let x=0;x<glyph.width;x++){
          const alpha = pixels[(y*glyph.width + x)*4 + 3];
          if(alpha>0) occ[row + x] = 1;
        }
      }
    }

    function deriveWordCloudSeed(agg, words){
      const topWord = words[0]?.word||'';
      const rangePart = `${agg.range?.min||''}|${agg.range?.max||''}`;
      const vocabHash = hashString(words.slice(0,40).map(w=>`${w.word}:${w.count}`).join('|'));
      return hashString(`${rangePart}|${topWord}|${words.length}|${vocabHash}`);
    }

    function getWordCloudFont(){
      return "ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial";
    }

    function hashString(str){
      let h = 1779033703 ^ str.length;
      for(let i=0;i<str.length;i++){
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return (h ^ (h >>> 16)) >>> 0;
    }

    function mulberry32(a){
      return function(){
        a |= 0; a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }

    function rerenderWordCloudScreen(){
      const cv = document.getElementById('wordCloudCanvas');
      if(cv instanceof HTMLCanvasElement && latestAgg){
        drawWordCloud(cv, latestAgg, 'screen');
      }
    }

    function chartCard(title, data, drawer){
      const card = html(`<div class="card"><h3>${title}</h3><canvas></canvas></div>`);
      const cv = card.querySelector('canvas');
      drawer(cv,data);
      return card;
    }

    function getCanvasDims(canvas){
      const ratio = canvas.__ratio || Math.max(2, window.devicePixelRatio||1);
      return {
        w: canvas.__cssWidth || (canvas.width/ratio),
        h: canvas.__cssHeight || (canvas.height/ratio)
      };
    }

    function drawLineChart(canvas, map){
      const ctx = setupCanvas(canvas);
      const {w,h} = getCanvasDims(canvas);
      const entries = Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
      const vals = entries.map(e=>e[1]); const max=Math.max(...vals,1);
      ctx.strokeStyle='#b14aed'; ctx.lineWidth=2; ctx.beginPath();
      entries.forEach((e,i)=>{ const x=i/(entries.length-1||1)*w; const y=h - (e[1]/max)*(h-20) -10; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.stroke();
    }

    function drawBarChartMonth(canvas, map){
      const ctx=setupCanvas(canvas);
      const {w,h} = getCanvasDims(canvas);
      const months = Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
      const max=Math.max(...months.map(m=>m[1]),1);
      months.forEach((m,i)=>{ const barW=w/months.length; const barH=(m[1]/max)*(h-20); ctx.fillStyle='#5d3fd3'; ctx.fillRect(i*barW+4, h-barH-10, barW-8, barH); });
    }

    function drawBarChartHours(canvas, arr){
      const ctx=setupCanvas(canvas); const max=Math.max(...arr,1); const {w,h}=getCanvasDims(canvas); const barW=w/24; arr.forEach((v,i)=>{ const barH=(v/max)*(h-20); ctx.fillStyle='#f59e0b'; ctx.fillRect(i*barW+2, h-barH-8, barW-4, barH); });
    }

    function drawBarChartWeekdays(canvas, arr){
      const ctx=setupCanvas(canvas); const max=Math.max(...arr,1); const {w,h}=getCanvasDims(canvas); const labels=['Pzt','Sal','Ã‡ar','Per','Cum','Cts','Paz']; const barW=w/7; arr.forEach((v,i)=>{ const barH=(v/max)*(h-20); ctx.fillStyle='#0ea5e9'; ctx.fillRect(i*barW+4, h-barH-8, barW-8, barH); ctx.fillStyle='#2d1b46'; ctx.fillText(labels[i], i*barW+10, h-2); });
    }

    function drawHistogram(canvas, buckets){
      const ctx=setupCanvas(canvas); const labels=['0-30sn','30-60sn','1-5dk','5-15dk','15-60dk','1-3s','3-10s','10-12s']; const max=Math.max(...buckets,1); const {w,h}=getCanvasDims(canvas); const barW=w/buckets.length; buckets.forEach((v,i)=>{ const barH=(v/max)*(h-20); ctx.fillStyle='#22c55e'; ctx.fillRect(i*barW+4, h-barH-12, barW-8, barH); ctx.fillStyle='#2d1b46'; ctx.font='12px sans-serif'; ctx.fillText(labels[i], i*barW+4, h-2); });
    }

    function drawMapChart(canvas, map){
      const ctx=setupCanvas(canvas); const entries = Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0])); const max=Math.max(...entries.map(e=>e[1]),1); const {w,h}=getCanvasDims(canvas); const barW=w/Math.max(entries.length,1); entries.forEach((e,i)=>{ const barH=(e[1]/max)*(h-20); ctx.fillStyle='#a855f7'; ctx.fillRect(i*barW+4, h-barH-10, barW-8, barH); ctx.fillStyle='#321b5a'; ctx.font='10px sans-serif'; ctx.fillText(e[0].slice(-3), i*barW+4, h-2); });
    }

    function drawOverlay(canvas, data){
      const ctx=setupCanvas(canvas); const {w,h}=getCanvasDims(canvas); const keys=data.map(d=>d.key); const segWidth=w/Math.max(data.length,1);
      const colors={msg:'#6366f1',laugh:'#f97316',rom:'#ec4899',datei:'#22c55e'};
      ['msgNorm','laughNorm','romNorm','dateiNorm'].forEach((field,idx)=>{
        ctx.beginPath(); ctx.strokeStyle=Object.values(colors)[idx]; data.forEach((d,i)=>{ const x=i*segWidth + segWidth/2; const y=h - (d[field]/100)*(h-20) - 10; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
      });
      ctx.fillStyle='#111'; ctx.font='10px sans-serif'; keys.forEach((k,i)=> ctx.fillText(k.slice(-2), i*segWidth+2, h-2));
    }

    function setupCanvas(canvas){
      const rect = canvas.getBoundingClientRect();
      const parentRect = canvas.parentElement?.getBoundingClientRect();
      const w = Math.max(rect.width||0, parentRect?.width||0, 640);
      const h = Math.max(rect.height||0, parentRect?.height||0, 260);
      const ratio = Math.max(2, window.devicePixelRatio||1);
      canvas.width = w*ratio;
      canvas.height=h*ratio;
      canvas.style.width = `${w}px`;
      canvas.style.height = `${h}px`;
      canvas.__cssWidth = w;
      canvas.__cssHeight = h;
      canvas.__ratio = ratio;
      const ctx=canvas.getContext('2d');
      ctx.setTransform(ratio,0,0,ratio,0,0);
      ctx.clearRect(0,0,w,h);
      ctx.strokeStyle='#222';
      ctx.lineWidth=2;
      return ctx;
    }

    function html(str){
      const t=document.createElement('template'); t.innerHTML=str.trim(); return t.content.firstElementChild;
    }

    function escapeHtml(str){
      const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
      return (str||'').replace(/[&<>"']/g,c=>map[c]||c);
    }

    function renderDebug(parsed, agg){
      debugEl.classList.remove('hidden');
      const msgCount = parsed.messages?.length ?? parsed.messagesCount ?? 0;
      const lines=[`Toplam satÄ±r: ${parsed.lines}`,`Toplam mesaj: ${msgCount}`,`Hata: ${parsed.parseErrors}`,`AralÄ±k: ${parsed.range.min?dayKey(parsed.range.min):'-'} â†’ ${parsed.range.max?dayKey(parsed.range.max):'-'}`];
      lines.push('TÃ¼r sayÄ±larÄ±: '+JSON.stringify(agg.kindsCount));
      if(agg.emojiDebug?.length) lines.push('Emoji Ã¶rnekleri: '+agg.emojiDebug.slice(0,20).join(' '));
      debugEl.innerHTML = '<strong>Debug</strong><br>'+lines.join('<br>');
      debugEl.appendChild(buildWordCloudControls());
    }

    function buildWordCloudControls(){
      const wrap = document.createElement('div');
      wrap.className = 'word-cloud-settings';
      wrap.innerHTML = `
        <div style="font-weight:800;margin-bottom:6px;">Word Cloud Settings</div>
        <label>Max kelime (ekran)</label>
        <select id="wcMaxWords">
          <option value="80">80</option>
          <option value="120">120</option>
          <option value="140">140</option>
          <option value="160">160</option>
        </select>
        <label>Min font (px) <span id="wcMinFontVal">${wordCloudConfig.minFont}</span></label>
        <input type="range" id="wcMinFont" min="12" max="26" value="${wordCloudConfig.minFont}">
        <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="wcRotate" ${wordCloudConfig.allowRotate?'checked':''}> Dikey kelimeler</label>
      `;
      const maxSel = wrap.querySelector('#wcMaxWords');
      if(maxSel) maxSel.value = String(wordCloudConfig.maxWordsScreen);
      maxSel?.addEventListener('change', ()=>{ wordCloudConfig.maxWordsScreen = Number(maxSel.value); rerenderWordCloudScreen(); });
      const minFont = wrap.querySelector('#wcMinFont');
      const minFontVal = wrap.querySelector('#wcMinFontVal');
      minFont?.addEventListener('input', ()=>{ wordCloudConfig.minFont = Number(minFont.value); if(minFontVal) minFontVal.textContent = wordCloudConfig.minFont; rerenderWordCloudScreen(); });
      const rotate = wrap.querySelector('#wcRotate');
      rotate?.addEventListener('change', ()=>{ wordCloudConfig.allowRotate = rotate.checked; rerenderWordCloudScreen(); });
      return wrap;
    }
  </script>
</body>
</html>
